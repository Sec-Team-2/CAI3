(todo el tema del venv)

sudo apt update
sudo apt upgrade
sudo apt install vault

sudo systemctl stop vault


sudo mkdir -p /vault/data
sudo chown -R $(whoami):$(whoami) /vault/data
chmod 750 /vault/data

cd certificados

openssl req -x509 -newkey rsa:4096 -keyout vault-server.key -out vault-server.crt -days 365 -nodes -config ../openssl.cnf
Poner en lo que pide lo mismo que al lado

sudo cp vault-server.crt /usr/local/share/ca-certificates/vault-server.crt
sudo update-ca-certificates



vault server -config=config.hcl (en una terminal distinta y en el directorio Consulta1)

#Iniciar vault. Solo al principio 
vault operator init

vault operator unseal con las 3 claves

export VAULT_ADDR='https://127.0.0.1:8200'

vault login <root_token>

cd ..

vault secrets enable kv

python generate_key.py

vault kv put kv/dicom key="clave_generada"


vault auth enable cert

cd certificados
openssl req -x509 -newkey rsa:4096 -keyout ca-key.pem -out ca-cert.pem -days 365 -nodes -subj "/CN=Vault CA"

openssl req -newkey rsa:4096 -keyout client-key.pem -out client-req.pem -nodes -subj "/CN=vault-client"
openssl x509 -req -in client-req.pem -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial -out client-cert.pem -days 365

# Configurar para usar la autoridad certificadora
vault write auth/cert/config \
    certificate=@ca-cert.pem \
    allowed_common_names="vault-client"

# Crear pol√≠tica de acceso
vault policy write read-secrets - <<EOF
path "kv/*" {
  capabilities = ["create", "update", "read", "list"]
}
EOF


# Permitir acceso a todos los clientes firmados por la CA
vault write auth/cert/certs/all-clients \
    display_name="all-clients" \
    certificate=@ca-cert.pem \
    policies="read-secrets"




